<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>模擬店レジ（オフライン対応）</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<style>
  :root { --gap:12px; --btn:64px; --font:18px; }
  html,body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; font-size: var(--font); background:#f7f7f7; }
  header { position: sticky; top:0; background:#fff; padding:12px; border-bottom:1px solid #eee; display:flex; gap:8px; align-items:center; z-index:10;}
  header h1 { font-size:20px; margin:0; flex:1; }
  main { display:grid; grid-template-columns: 1.2fr 1fr; gap: var(--gap); padding: var(--gap); }
  @media (max-width: 1000px) { main { grid-template-columns: 1fr; } }
  .panel { background:#fff; border:1px solid #eee; border-radius:10px; padding:var(--gap); }
  .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:var(--gap); min-height:180px; }
  @media (max-width: 800px) { .grid { grid-template-columns: repeat(2, 1fr); } }
  button.item { height:var(--btn); font-size:18px; border:1px solid #ddd; border-radius:10px; background:#fafafa; white-space:pre-line; }
  table { width:100%; border-collapse: collapse; }
  th,td { border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align: middle; }
  td.qty { width:130px; }
  .qtybtn { width:36px; height:36px; border:1px solid #ddd; border-radius:8px; background:#fff; }
  .muted { color:#888; font-size:14px; }
  .totals { display:flex; flex-direction:column; gap:6px; margin-top:12px; }
  .totals .row { display:flex; justify-content:space-between; }
  .pay { display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; }
  .pay input { font-size:24px; padding:8px; width:100%; }
  .keys { display:flex; flex-wrap:wrap; gap:8px; }
  .keys button { padding:10px 14px; border:1px solid #ddd; border-radius:8px; background:#fff; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; }
  .primary { background:#111; color:#fff; border:1px solid #111; }
  .danger { background:#b00020; color:#fff; border:1px solid #b00020; }
  dialog { border:none; border-radius:12px; padding:0; max-width:860px; width:90vw; }
  .dlg { padding:16px; }
  .dlg h3 { margin:0 0 8px; }
  .form-row { display:grid; grid-template-columns: 1fr 120px; gap:8px; align-items:center; margin-bottom:6px;}
  .form-row input { width:100%; padding:8px; font-size:16px; }
  .right { text-align:right; }
  .flex-end { display:flex; justify-content:flex-end; gap:8px; }
  .tag { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#0a7f2e; }
</style>
</head>
<body>
<header>
  <h1>模擬店レジ</h1>
  <button class="chip" id="openManage">メニュー</button>
  <button class="chip" id="openHistory">売上履歴</button>
  <button class="chip" id="openStats">販売状況</button>
  <button class="chip" id="exportCsv">CSV出力</button>
</header>

<main>
  <section class="panel">
    <div class="muted">タップで追加</div>
    <div class="grid" id="itemsGrid"></div>
  </section>

  <section class="panel">
    <table id="cartTable">
      <thead>
        <tr><th>商品</th><th class="right">単価</th><th class="qty">数量</th><th class="right">小計</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="totals">
      <div class="row"><div>小計</div><div id="subtotal" class="right">¥0</div></div>
      <div class="row"><div>割引</div><div id="discount" class="right">¥0</div></div>
      <div class="row" style="font-size:22px;font-weight:700;"><div>合計</div><div id="total" class="right">¥0</div></div>
    </div>
    <div class="pay" style="margin-top:12px;">
      <input id="cashInput" type="number" inputmode="numeric" placeholder="受取金額（円）">
      <div class="keys">
        <button data-cash="100">+100</button>
        <button data-cash="500">+500</button>
        <button data-cash="1000">+1,000</button>
        <button id="exact">ぴったり</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="muted">お釣り</div>
      <div id="change" class="right" style="font-size:22px;font-weight:700;">¥0</div>
    </div>
    <div class="actions" style="margin-top:12px;">
      <button id="checkout" class="primary">会計確定</button>
      <button id="clearCart" class="danger">カート全クリア</button>
    </div>
    <div class="muted" style="margin-top:8px;">注文番号：<span id="orderNo">--</span></div>
  </section>
</main>

<dialog id="manageDlg">
  <div class="dlg">
    <h3>メニュー（名前と価格だけ編集）</h3>
    <div id="manageList"></div>
    <div class="flex-end" style="margin-top:12px;">
      <button id="addItemBtn">商品追加</button>
      <button id="saveAllItems" class="primary">すべて保存</button>
      <button id="closeManage">閉じる</button>
    </div>
  </div>
</dialog>

<dialog id="historyDlg">
  <div class="dlg">
    <h3>売上履歴 <span class="muted" id="historySummary"></span></h3>
    <table style="margin-top:8px; width:100%;">
      <thead><tr><th>時間</th><th>No</th><th>合計</th><th>明細</th><th>編集</th></tr></thead>
      <tbody id="historyBody"></tbody>
    </table>
    <div class="flex-end" style="margin-top:12px;">
      <button id="closeHistory" class="primary">閉じる</button>
    </div>
  </div>
</dialog>

<dialog id="editOrderDlg">
  <div class="dlg">
    <h3>注文編集 <span id="editOrderNo"></span></h3>
    <table id="editTable" style="width:100%;">
      <thead><tr><th>商品</th><th>単価</th><th>数量</th><th class="right">小計</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="flex-end" style="margin-top:10px;">
      <div style="flex:1;text-align:right;">合計：<strong id="editTotal">¥0</strong></div>
      <button id="saveOrder" class="primary">保存</button>
      <button id="cancelEdit">閉じる</button>
    </div>
  </div>
</dialog>

<dialog id="statsDlg">
  <div class="dlg">
    <h3>販売状況（品目別）</h3>
    <table id="statsTable" style="width:100%;">
      <thead><tr><th>商品</th><th class="right">個数</th><th class="right">売上</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="flex-end" style="margin-top:12px;">
      <button id="closeStats" class="primary">閉じる</button>
    </div>
  </div>
</dialog>

<script>
(function(){
  // フェイルセーフ：エラーを拾ってユーザーに見えるように
  window.onerror = function(msg, src, line, col, err){ alert("読み込みエラー: " + msg); };

  function $(sel){ return document.querySelector(sel); }
  function fmt(n){ return '¥' + (n||0).toLocaleString('ja-JP'); }
  function nowIso(){ return new Date().toISOString(); }
  function nextOrderId(seq){ return String(seq).padStart(4,'0'); }
  function sum(arr, f){ return arr.reduce((a,x)=> a+f(x), 0); }

  const idb = {
    db: null,
    open(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open('mogi-pos', 2);
        req.onupgradeneeded = e=>{
          const db = e.target.result;
          if (!db.objectStoreNames.contains('items')) db.createObjectStore('items',{keyPath:'id'});
          if (!db.objectStoreNames.contains('orders')) db.createObjectStore('orders',{keyPath:'id'});
          if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta',{keyPath:'key'});
        };
        req.onsuccess = e=>{ idb.db = e.target.result; resolve(); };
        req.onerror = e=> reject(e);
      });
    },
    tx(s,m){ return idb.db.transaction(s,m).objectStore(s); },
    get(s,k){ return new Promise((res,rej)=>{ const r=idb.tx(s,'readonly').get(k); r.onsuccess=()=>res(r.result); r.onerror=rej; }); },
    getAll(s){ return new Promise((res,rej)=>{ const r=idb.tx(s,'readonly').getAll(); r.onsuccess=()=>res(r.result); r.onerror=rej; }); },
    put(s,v){ return new Promise((res,rej)=>{ const r=idb.tx(s,'readwrite').put(v); r.onsuccess=()=>res(); r.onerror=rej; }); },
    del(s,k){ return new Promise((res,rej)=>{ const r=idb.tx(s,'readwrite').delete(k); r.onsuccess=()=>res(); r.onerror=rej; }); },
  };

  const DEFAULT_ITEMS = [
    { id:'drip', name:'ドリップコーヒー', price:300, category:'ドリンク' },
    { id:'tea',  name:'紅茶',             price:300, category:'ドリンク' },
    { id:'affo', name:'アフォガード',     price:450, category:'スイーツ' },
    { id:'latte',name:'ラテ',             price:380, category:'ドリンク' },
  ];

  const state = { items:[], cart:[], orderSeq:1, editingOrder:null };

  async function init(){
    await idb.open();
    // 初回のみデフォルト商品を投入（さっきまでと同じ仕様）
    const existing = await idb.getAll('items');
    if (!existing || existing.length === 0){
      for (const it of DEFAULT_ITEMS) await idb.put('items', it);
    }
    state.items = await idb.getAll('items');
    const meta = await idb.get('meta','orderSeq');
    state.orderSeq = (meta && meta.value) ? meta.value : 1;

    renderItems();
    renderCart();
    updateOrderNo();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    // ヘッダーボタン
    $('#openManage').addEventListener('click', openManage);
    $('#openHistory').addEventListener('click', openHistory);
    $('#openStats').addEventListener('click', openStats);
    $('#exportCsv').addEventListener('click', exportCsv);

    // 会計側
    $('#exact').addEventListener('click', ()=> { $('#cashInput').value = calcTotal(); updateChange(); });
    document.querySelectorAll('[data-cash]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const inc = parseInt(btn.dataset.cash,10);
        const v = parseInt($('#cashInput').value||0,10);
        $('#cashInput').value = (v+inc);
        updateChange();
      });
    });
    $('#cashInput').addEventListener('input', updateChange);
    $('#checkout').addEventListener('click', onCheckout);
    $('#clearCart').addEventListener('click', ()=>{ state.cart=[]; renderCart(); });
  }

  function renderItems(){
    const wrap = $('#itemsGrid');
    wrap.innerHTML = '';
    state.items.forEach(it=>{
      const btn = document.createElement('button');
      btn.className = 'item';
      btn.textContent = it.name + '\n' + fmt(it.price);
      btn.addEventListener('click', ()=> addToCart(it));
      wrap.appendChild(btn);
    });
  }

  function addToCart(it){
    const line = state.cart.find(l=> l.id===it.id && l.price===it.price);
    if (line) line.qty++;
    else state.cart.push({ id:it.id, name:it.name, price:it.price, qty:1 });
    renderCart();
  }
  function changeQty(id,delta){
    const line = state.cart.find(l=> l.id===id);
    if (!line) return;
    line.qty += delta;
    if (line.qty<=0) state.cart = state.cart.filter(l=>l.id!==id);
    renderCart();
  }
  function lineTotal(l){ return l.price * l.qty; }
  function calcSubtotal(){ return state.cart.reduce((a,l)=> a+lineTotal(l), 0); }
  function calcTotal(){ return calcSubtotal(); }
  function renderCart(){
    const tbody = $('#cartTable tbody');
    tbody.innerHTML='';
    for (const l of state.cart) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${l.name}</td>
        <td class="right">${fmt(l.price)}</td>
        <td class="qty">
          <button class="qtybtn" data-act="minus">-</button>
          <span style="display:inline-block; width:36px; text-align:center;">${l.qty}</span>
          <button class="qtybtn" data-act="plus">+</button>
        </td>
        <td class="right">${fmt(lineTotal(l))}</td>
        <td class="right"><button class="qtybtn" data-act="remove">×</button></td>
      `;
      tr.querySelector('[data-act="minus"]').addEventListener('click', ()=> changeQty(l.id,-1));
      tr.querySelector('[data-act="plus"]').addEventListener('click', ()=> changeQty(l.id,+1));
      tr.querySelector('[data-act="remove"]').addEventListener('click', ()=>{ state.cart = state.cart.filter(x=>x.id!==l.id); renderCart(); });
      tbody.appendChild(tr);
    }
    $('#subtotal').textContent = fmt(calcSubtotal());
    $('#discount').textContent = fmt(0);
    $('#total').textContent = fmt(calcTotal());
    updateChange();
  }
  function updateOrderNo(){ $('#orderNo').textContent = nextOrderId(state.orderSeq); }
  function updateChange(){
    const cash = parseInt($('#cashInput').value||0,10);
    const chg = Math.max(0, cash - calcTotal());
    $('#change').textContent = fmt(chg);
    $('#change').className = chg>=0 ? 'right good' : 'right bad';
  }

  async function onCheckout(){
    if (state.cart.length===0) { alert('カートが空です'); return; }
    const cash = parseInt($('#cashInput').value||0,10);
    const total = calcTotal();
    if (isNaN(cash) || cash < total) { alert('受取金額が不足しています'); return; }

    const order = {
      id: 'o-' + nowIso(),
      orderNo: nextOrderId(state.orderSeq),
      ts: nowIso(),
      lines: state.cart.map(l=>({id:l.id, name:l.name, unit:l.price, qty:l.qty, line:l.price*l.qty})),
      subtotal: total,
      discount: 0,
      total: total,
      cash: cash,
      change: cash-total,
      edited: false
    };
    await idb.put('orders', order);

    state.cart = [];
    $('#cashInput').value = '';
    updateChange();
    renderCart();

    state.orderSeq += 1;
    await idb.put('meta', { key:'orderSeq', value: state.orderSeq });
    updateOrderNo();

    alert(`注文 #${order.orderNo} 会計完了。お釣り：${fmt(order.change)}`);
  }

  // --- メニュー編集 ---
  function openManage(){
    buildManageList();
    const dlg = $('#manageDlg'); dlg.showModal();
    $('#addItemBtn').onclick = addItemFormRow;
    $('#saveAllItems').onclick = saveAllItems;
    $('#closeManage').onclick = ()=> dlg.close();
  }
  function buildManageList(){
    const box = $('#manageList');
    box.innerHTML = '';
    state.items.forEach(it=> {
      const row = document.createElement('div');
      row.className='form-row';
      row.innerHTML = `
        <input value="${it.name}" data-k="name">
        <input type="number" value="${it.price}" data-k="price">
      `;
      row.dataset.id = it.id;
      box.appendChild(row);
    });
  }
  async function saveAllItems(){
    const rows = Array.from(document.querySelectorAll('#manageList .form-row'));
    for (const row of rows){
      const id = row.dataset.id;
      const it = state.items.find(x=>x.id===id);
      const name = row.querySelector('[data-k="name"]').value.trim();
      const price = Math.max(0, parseInt(row.querySelector('[data-k="price"]').value||0,10));
      it.name = name || it.name;
      it.price = price;
      await idb.put('items', it);
    }
    state.items = await idb.getAll('items');
    renderItems();
    alert('保存しました');
  }
  function addItemFormRow(){
    const nid = 'i-' + Math.random().toString(36).slice(2,8);
    const it = { id:nid, name:'新商品', price:0, category:'' };
    state.items.push(it);
    const box = $('#manageList');
    const row = document.createElement('div');
    row.className='form-row';
    row.dataset.id = nid;
    row.innerHTML = `<input value="${it.name}" data-k="name"><input type="number" value="${it.price}" data-k="price">`;
    box.appendChild(row);
  }

  // --- 売上履歴/編集/販売状況（v3の仕様を踏襲） ---
  async function openHistory(){
    await renderHistory();
    const dlg = $('#historyDlg'); dlg.showModal();
    $('#closeHistory').onclick = ()=> dlg.close();
  }
  async function renderHistory(){
    const orders = (await idb.getAll('orders')).sort((a,b)=> a.ts<b.ts?1:-1);
    const t = orders.reduce((s,o)=> s+o.total, 0);
    $('#historySummary').textContent = `件数：${orders.length}　通算売上：${fmt(t)}`;
    const body = $('#historyBody'); body.innerHTML = '';
    for (const o of orders) {
      const detail = o.lines.map(l=> `${l.name}×${l.qty}`).join('、');
      const mark = o.edited ? '<span class="tag">✔ 編集済み</span>' : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(o.ts).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}</td>
        <td>${o.orderNo}</td><td class="right">${fmt(o.total)}</td><td>${detail} ${mark}</td>
        <td><button data-act="edit">編集</button></td>`;
      tr.querySelector('[data-act="edit"]').addEventListener('click', ()=> openEditOrder(o.id));
      body.appendChild(tr);
    }
  }
  async function openEditOrder(orderId){
    const o = await idb.get('orders', orderId); if (!o) return;
    state.editingOrder = o;
    $('#editOrderNo').textContent = `#${o.orderNo}`;
    const body = $('#editTable tbody'); body.innerHTML='';
    for (const l of o.lines){
      const tr = document.createElement('tr');
      tr.dataset.itemId = l.id;
      tr.innerHTML = `<td>${l.name}</td>
        <td><input type="number" value="${l.unit}" data-k="unit" style="width:100px;"></td>
        <td><input type="number" value="${l.qty}" data-k="qty" style="width:80px;"></td>
        <td class="right" data-k="line">${fmt(l.unit*l.qty)}</td>
        <td><button data-act="rm">×</button></td>`;
      tr.querySelector('[data-k="unit"]').addEventListener('input', ()=> recalcEditRow(tr));
      tr.querySelector('[data-k="qty"]').addEventListener('input', ()=> recalcEditRow(tr));
      tr.querySelector('[data-act="rm"]').addEventListener('click', ()=> { tr.remove(); recalcEditTotal(); });
      body.appendChild(tr);
    }
    recalcEditTotal();
    const dlg = $('#editOrderDlg'); dlg.showModal();
    $('#cancelEdit').onclick = ()=> dlg.close();
    $('#saveOrder').onclick = saveEditedOrder;
  }
  function recalcEditRow(tr){
    const unit = parseInt(tr.querySelector('[data-k="unit"]').value||0,10);
    const qty = parseInt(tr.querySelector('[data-k="qty"]').value||0,10);
    tr.querySelector('[data-k="line"]').textContent = fmt(unit*qty);
    recalcEditTotal();
  }
  function recalcEditTotal(){
    const rows = Array.from(document.querySelectorAll('#editTable tbody tr'));
    const total = rows.reduce((s, tr)=>{
      const unit = parseInt(tr.querySelector('[data-k="unit"]').value||0,10);
      const qty = parseInt(tr.querySelector('[data-k="qty"]').value||0,10);
      return s + unit*qty;
    }, 0);
    $('#editTotal').textContent = fmt(total);
  }
  async function saveEditedOrder(){
    const rows = Array.from(document.querySelectorAll('#editTable tbody tr'));
    const lines = rows.map(tr=>{
      const id = tr.dataset.itemId;
      const name = tr.children[0].textContent;
      const unit = parseInt(tr.querySelector('[data-k="unit"]').value||0,10);
      const qty = parseInt(tr.querySelector('[data-k="qty"]').value||0,10);
      return { id, name, unit, qty, line: unit*qty };
    }).filter(x=> x.qty>0 && x.unit>=0);
    const total = lines.reduce((s,l)=> s+l.line, 0);
    const o = state.editingOrder;
    o.lines = lines; o.total = total; o.subtotal = total; o.change = (o.cash||total) - total; o.edited = true;
    await idb.put('orders', o);
    $('#editOrderDlg').close();
    await renderHistory();
    alert('注文を更新しました');
  }

  async function openStats(){
    const orders = await idb.getAll('orders');
    const map = new Map();
    for (const o of orders){ for (const l of o.lines){ const m = map.get(l.name)||{qty:0,rev:0}; m.qty+=l.qty; m.rev+=l.line; map.set(l.name,m); } }
    const data = Array.from(map.entries()).map(([name,m])=>({name, qty:m.qty, rev:m.rev})).sort((a,b)=> b.qty-a.qty);
    const tbody = $('#statsTable tbody'); tbody.innerHTML='';
    for (const r of data){ const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.name}</td><td class="right">${r.qty}</td><td class="right">${fmt(r.rev)}</td>`; tbody.appendChild(tr); }
    $('#statsDlg').showModal(); $('#closeStats').onclick = ()=> $('#statsDlg').close();
  }

  async function exportCsv(){
    const orders = await idb.getAll('orders');
    const rows = [['time','orderNo','item','qty','unit','line','total','cash','change','edited']];
    for (const o of orders) {
      for (const l of o.lines) rows.push([o.ts, o.orderNo, l.name, l.qty, l.unit, l.line, o.total, o.cash||'', o.change||'', o.edited?1:0]);
    }
    const csv = rows.map(r=> r.map(x=>{ const s=(x??'').toString(); return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; }).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`sales-${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  // DOMContentLoadedで初期化（より確実に）
  window.addEventListener('DOMContentLoaded', ()=>{ init().catch(err=> alert('初期化エラー: ' + err)); });
})();
</script>
</body>
</html>
